## Bayesian calibration
**is different from calibration (Bayesian inference) in SD community**

### 1. What
Calibrating Bayes model, modularized as `prior`, `family`, `posterior-approximator`

### 2. How
- Make three modules internally consistent and external consistent with data 
- Follow Demand-Draws-Data process with `Vensim-SDA, Stan-SBC, BATS-SOPS` tool

### 3. Why
- Use both process model (causal-policy, long term) and statistics model (statistical-forecast, short term) 

### 4. Who
- Between two: User, Program, 
- Between three + their interaction: `prior`, `family`, `posterior-approximator` 
- Between six + their interaction: `Vensim-SDA` (Generator, approximation error), `Stan-SBC` (Discriminator, optimization error), `BATS-SOPS` (empirical setting, precision, statistical error) 

### 5. When
- Building model family tree

---

## 1. What

### Prior function()  
#### What: Probability measure and Pooler

| -          | `demand_prior()`     | `relational_prior()` | `variation_prior()`        |  
| ---------- | -------------------- | ------------------ | ------------------------ | 
| type       | objective function   | set of equalities  | probability distribution | 
| Stan block | generated quantities | function           | model                    | 

#### How: Scale-separation, Restrict to, Regulate against

Based on teachings From Good83, BDA, and Andrew, my prior building principles are:
- 🗡 (restrict to) `geometric-inspired` which is on hyperplane (e.g. [inductive prior](https://youtu.be/bIZB1hIJ4u8?t=334) for GDL)
- 🛡 (regularize against) `tight` (against diffuse), `defensive` (against worst cases like outlier), `reverse-engineered` (against bad predictive checks)

Especially, prior for variance parameter which learns heterogeneity in hierarchical model; Andrew's long history of research on the variance prior (half-t (2006), gamma/inverse gamma, half normal, zero-avoiding (2012), currently tight prior (we've been working on this). Refutations exist for zero-excluding by Dan [here](https://statmodeling.stat.columbia.edu/2018/05/04/zero-excluding-priors-probably-bad-idea-hierarchical-variance-parameters/).

#### Why: Core of Simulation and Bayesian is "device of imaginary results" (Good83)

### family  
```
binomial(link = "logit")
gaussian(link = "identity")
Gamma(link = "inverse")
inverse.gaussian(link = "1/mu^2")
poisson(link = "log")
quasi(link = "identity", variance = "constant")
quasibinomial(link = "logit")
quasipoisson(link = "log")

link:	a specification for the model link function. This can be a name/expression, a literal character string, a length-one character vector, or an object of class "link-glm" (such as generated by make.link) provided it is not specified via one of the standard names given next.

The gaussian family accepts the links (as names) identity, log and inverse; the binomial family the links logit, probit, cauchit, (corresponding to logistic, normal and Cauchy CDFs respectively) log and cloglog (complementary log-log); the Gamma family the links inverse, identity and log; the poisson family the links log, identity, and sqrt; and the inverse.gaussian family the links 1/mu^2, inverse, identity and log.

The quasi family accepts the links logit, probit, cloglog, identity, inverse, log, 1/mu^2 and sqrt, and the function power can be used to create a power link function.
```

### posterior-approximator
can be found in [[5 Algorithms for Optimization]].

## 2. How
Given parameter and data as follows:

### Parameter
Combination of `prior_function()` and data Prior_Param.

| -          | `demand_prior()`     | `relational_prior()` | `variation_prior()`        |  
| ---------- | -------------------- | ------------------ | ------------------------ | 
| type       | objective function   | set of equalities  | probability distribution | 
| Stan block | generated quantities | function           | model                    | 

### Data
| -              | Prior_param       | SynData                                            | Data                         | (Posterior) Draws                                                                                                       | Precision |
| -------------- | ----------------- | -------------------------------------------------- | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------- | --------- |
| type           | vector            | xarray                                             | xarray                       |                                                                                                                         |  real         |
| Stan block     | model             | .                                                  | data                         |                                                                                                                         |      transformed parameter     |
| source | user's assumption | `relation_prior(variation_prior(prior_parameter))` | to be collected with purpose | `post_approx`(`Data`, `relational_prior(variation_prior(`Prior_Param`))`, `variation_prior(`Prior_Param`)`, Precision`))` |           |


checks internal and external consistency with three check functions. SBC verifies internal consistency, Prior predictive and posterior predictive, (+sensitivity check) validate external consistency.

<img width="1087" alt="image" src="https://user-images.githubusercontent.com/30194633/183689023-91d490d7-b182-4eba-ad6e-ecca7ea0d099.png">


#### Check function()
| -                      | measured distance between                                                                                    | 
| ---------------------- | ---------------------------------------------------------------------------------------------------- | 
| Prior predictive check | SynData VS Data        |     |
| SBC                    | `variation_prior()` VS  `post_approx(`Data, `relational_prior(variation_prior(`Prior_Param`))`, `variation_prior(`Prior_Param`)`, Precision`))` |    
| Posterior predictive check                       |  Data VS relational_prior(Draws)                                                                                                    |     |
		

## 3. Why
### Combining Long term and short term modeling 
- Oliva20 introduce two cultures of explainability: variation and process
- Yaman's slide on comparison of (a) exogenous, static, forecasting and (b) endogenous, dynamic, policy model for city population

<img width="1035" alt="image" src="https://user-images.githubusercontent.com/30194633/183689650-bfe7d048-f724-4c0b-aeaa-d86b4397a289.png">


## 4. Who

### User-Program WF: One actor and its tool

| Step | Program's work (P-rows have `.function(input)`)                                                      | User's work                                                                                                 | added info (for U-row) or infrastructure (for P-row)       -            | out format                    |
| ---- | ---------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- | ----------------------------- |
| U1   | `Vensim` assists U1.a()                                                                              | a. Translate mental model to SD model                                                                       | Relation btw Variables                                                  | `.mdl`                        |
| U2   | `PySD` assists U2.a()                                                                                | a. Classify parameters `est_param`, `ass_param`, b. Select `obs_state` among stocks                         | Want (`est_param`) and Have (assume: `ass_param`, observe: `obs_state`) | `.json`                       |
| P1   | `PySD`, `.read_vensim`(U1.a): Switch lang. from FP to OOP                                            |                                                                                                             | None                                                                    | `.py`                         |
| U3   |                                                                                                      | a. Supply value or series of `assmed_param`, b. Choose `family`(:= dist. of `msr_err_scale`)                |                                                                         | DataFrame `object`,   `.json` |
| U4   |                                                                                                      | a. Choose `prior_family`(`est_param`'s prior dist. type) , b. Set `prior_param` (`est_param`'s prior param) |                                                                         | `.json`                       |
| P2   | `PySD`, `.run`(U2.ab, U3.ab): Generate synthetic data                                                |                                                                                                             |                                                                         | DataFrame `object`            |
| P3   | `PySD`,`.create_stan_program`(U2.ab, U3.ab): Switch lang. from OOP to PPL                            |                                                                                                             |                                                                         | `.stan`                       |
| U5   |                                                                                                      | a. Set precision with `iter_sampling` (:= # of samples)                                                     |                                                                         | `int`                         |
| P4   | `Stan`, `.sample`(P2, P3, U5.a)): Sample posterior draws (optimize measure with specified precision) |                                                                                                             |                                                                         | DataFrame `object`            |

### Bayesian WF: Between three modules 
- Bayesian workflow [paper](https://arxiv.org/pdf/2011.01808.pdf)
- more focused on SBC as prior calibrator; relevent references on theory and application can be found [here](https://hyunjimoon.github.io/SBC/#references)

### SilkRoad WF: Between six softwares (`Vensim-SDA, Stan-SBC, BATS-SOPS`)

- Program perceived `Demand` with `Vensim-SDA`, Compute scientific `Draws` with `Stan-SBC`, Supply rationing `Data` with `BATS-SOPS`
- Diagrams and details for each Software is detailed [here](https://github.com/hyunjimoon/DataInDM/blob/main/Recitation/3%20Desire%20Draws%20Data.md#3-879-fall-nondiscrete-data---draws---demand)
- SilkRoad project aims to connect the above whose motivation is detailed [here](https://github.com/hyunjimoon/DataInDM#demand-of-silkroad-project).

| Step                          | Output                          | Software                                                    | Symbol  | Description                                                                        | opensource? (language)          |
| ----------------------------- | ------------------------------- | ----------------------------------------------------------- | ------------ | ------------------------------------------------------------------------ | -------------------- |
| 1. Program Perceived `Demand` | a. Perceived Demand             | [Vensim](https://vensim.com/)                               | 👁 Eye        | Reads mental model, Translates to cyclic directed graph `generator`   | X (has free version)  |
| 1.                            | b. Analyzed Demand              | [SDA](http://people.tamu.edu/~roliva/research/sd/sda/)      | 🧠 Brain     | Finds dominant cycle of `generator`, Maps with system behavior         | O (Mathematica, R)   |
| -                             |                                 |                                                             |              |                                                                          |                      |
| 2. Compute Scientific `Draws` | a. Computed Draws               | [Stan](https://mc-stan.org/)                                | 🐴 Workhorse | Builds posterior space, Runs HMC, ADVI, BFGS for representative draws | O (Stan connected to Python, R, Julia) |
| 2.                            | b. Verified and Validated Draws | [SBC](https://hyunjimoon.github.io/SBC/articles/index.html) | 👌 Test      |Diagnoses graphically, Calibrates architecture, policy, parameter prior `discriminator`       | O (R)                |
| -                             |                                 |                                                             |              |                                                                          |                      |
| 3. Collect Supporting `Data`  | a. Theoretical Policy Parameter | BATS (communicating with Yaman, Gönenç)                     | 🦇 Explore   | Specifies policy parameter for demanded behavior                        | O (Python)           |
| 3.                            | b. Empirical Policy Parameter   | SOPS (communicating with Erling)                            | 🚀  One-shot |Optimizes policy one-shot in stochastic dynamic system               | O (Powersim)         |
| -                             |                                 |                                                             |              |                                                                          |                      |
|     Iterate and communicate                          |   Hub `pysd`, `readsdr`                               | [PySD](https://pysd.readthedocs.io/en/master/), [readsdr](https://github.com/jandraor/readsdr)                                                            |  🗣 Language            |                                                                          |     O (Python, R)               |

## 5. When
Demand-based multiverse analysis as part of model development

- Stat: Sec.7.3 Topology of models from Bayesian Workflow paper
- Comp: Model tree software [MStan](http://ryanbe.me/) modular stan for timeseries
